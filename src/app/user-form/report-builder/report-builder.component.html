<div class="report-wrapper" *ngIf="config && form">

  <div class="report-header">
    {{ config.title }}
    <span class="info-icon">i</span>
  </div>

  <div class="report-card">

    <div class="section-header">Report Parameters</div>

    <form [formGroup]="form" class="form-body" (ngSubmit)="$event.preventDefault()">

      <!-- FIX: Use grid layout for proper responsive design -->
      <div class="form-grid">
        
        <!-- FIX: Move ngClass to a div wrapper instead of ng-container -->
        <div *ngFor="let f of config.fields" [ngClass]="getWrapperClasses(f)">

          <!-- DROPDOWN -->
          <ng-container *ngIf="f.type === 'dropdown'">
            
            <!-- Default Layout -->
            <ng-container *ngIf="!f.layoutMode || f.layoutMode === 'default'">
              <label [for]="f.key" [ngClass]="f.labelClass || ''">
                {{ getFieldLabel(f) }}
                <span *ngIf="f.required" class="required">*</span>
              </label>

              <!-- Multi-select: Show Select All button -->
               @if(f.multiple && fieldOptions[f.key]){
               @if( fieldOptions[f.key].length > 0){
              <div  class="select-all-container">
                <button 
                  type="button" 
                  class="btn-select-all"
                  (click)="toggleSelectAll(f.key)">
                  {{ isAllSelected(f.key) ? 'Deselect All' : 'Select All' }}
                </button>
              </div>
            }}

              <select 
                [id]="f.key"
                class="form-control" 
                [formControlName]="f.key" 
                [multiple]="f.multiple"
                [ngClass]="f.inputClass || ''"
                [class.is-invalid]="form.get(f.key)?.invalid && form.get(f.key)?.touched"
                [attr.disabled]="!fieldReady[f.key] ? true : null">

                <option *ngIf="fieldLoading[f.key]" disabled>Loading...</option>
                <option *ngIf="!f.multiple && !fieldLoading[f.key]" value="">
                  {{ fieldReady[f.key] ? 'Select' : '' }}
                </option>
                <option *ngFor="let o of fieldOptions[f.key]" [value]="o.id">
                  {{ o.name }}
                </option>
              </select>
            </ng-container>

            <!-- Split Layout -->
            <ng-container *ngIf="f.layoutMode === 'split'">
              <div class="field-split-layout">
                <label [for]="f.key" [ngClass]="(f.labelClass || '') + ' ' + (f.labelWidth || 'col-span-3')">
                  {{ getFieldLabel(f) }}
                  <span *ngIf="f.required" class="required">*</span>
                </label>

                <div [ngClass]="f.inputWidth || 'col-span-9'">
                  <div *ngIf="f.multiple && fieldOptions[f.key] && fieldOptions[f.key].length > 0" class="select-all-container">
                    <button 
                      type="button" 
                      class="btn-select-all"
                      (click)="toggleSelectAll(f.key)">
                      {{ isAllSelected(f.key) ? 'Deselect All' : 'Select All' }}
                    </button>
                  </div>

                  <select 
                    [id]="f.key"
                    class="form-control" 
                    [formControlName]="f.key" 
                    [multiple]="f.multiple"
                    [ngClass]="f.inputClass || ''"
                    [class.is-invalid]="form.get(f.key)?.invalid && form.get(f.key)?.touched"
                    [attr.disabled]="!fieldReady[f.key] ? true : null">

                    <option *ngIf="fieldLoading[f.key]" disabled>Loading...</option>
                    <option *ngIf="!f.multiple && !fieldLoading[f.key]" value="">
                      {{ fieldReady[f.key] ? 'Select' : '' }}
                    </option>
                    <option *ngFor="let o of fieldOptions[f.key]" [value]="o.id">
                      {{ o.name }}
                    </option>
                  </select>
                </div>
              </div>
            </ng-container>

            <!-- Inline Layout -->
            <ng-container *ngIf="f.layoutMode === 'inline'">
              <div class="field-inline-layout">
                <label [for]="f.key" [ngClass]="f.labelClass || ''">
                  {{ getFieldLabel(f) }}
                  <span *ngIf="f.required" class="required">*</span>
                </label>

                <select 
                  [id]="f.key"
                  class="form-control" 
                  [formControlName]="f.key" 
                  [multiple]="f.multiple"
                  [ngClass]="f.inputClass || ''"
                  [class.is-invalid]="form.get(f.key)?.invalid && form.get(f.key)?.touched"
                  [attr.disabled]="!fieldReady[f.key] ? true : null">

                  <option *ngIf="fieldLoading[f.key]" disabled>Loading...</option>
                  <option *ngIf="!f.multiple && !fieldLoading[f.key]" value="">
                    {{ fieldReady[f.key] ? 'Select' : '' }}
                  </option>
                  <option *ngFor="let o of fieldOptions[f.key]" [value]="o.id">
                    {{ o.name }}
                  </option>
                </select>
              </div>
            </ng-container>

            <!-- Validation message -->
            <div *ngIf="form.get(f.key)?.invalid && form.get(f.key)?.touched" class="error-message">
              This field is required
            </div>
          </ng-container>

          <!-- CHECKBOX -->
          <ng-container *ngIf="f.type === 'checkbox'">
            
            <!-- Default Layout -->
            <ng-container *ngIf="!f.layoutMode || f.layoutMode === 'default'">
              <label [for]="f.key" class="checkbox-label">
                <input 
                  type="checkbox" 
                  [id]="f.key"
                  [formControlName]="f.key" 
                  [ngClass]="f.inputClass || ''" />
                {{ getFieldLabel(f) }}
                <span *ngIf="f.required" class="required">*</span>
              </label>
            </ng-container>

            <!-- Split Layout -->
            <ng-container *ngIf="f.layoutMode === 'split'">
              <div class="field-split-layout">
                <label [ngClass]="(f.labelClass || '') + ' ' + (f.labelWidth || 'col-span-3')">
                  {{ getFieldLabel(f) }}
                  <span *ngIf="f.required" class="required">*</span>
                </label>

                <div [ngClass]="f.inputWidth || 'col-span-9'">
                  <label [for]="f.key" class="checkbox-label">
                    <input 
                      type="checkbox" 
                      [id]="f.key"
                      [formControlName]="f.key" 
                      [ngClass]="f.inputClass || ''" />
                    <span class="checkbox-inline-text">{{ f.label }}</span>
                  </label>
                </div>
              </div>
            </ng-container>

            <!-- Inline Layout -->
            <ng-container *ngIf="f.layoutMode === 'inline'">
              <div class="field-inline-layout">
                <label [for]="f.key" class="checkbox-label">
                  <input 
                    type="checkbox" 
                    [id]="f.key"
                    [formControlName]="f.key" 
                    [ngClass]="f.inputClass || ''" />
                  {{ getFieldLabel(f) }}
                  <span *ngIf="f.required" class="required">*</span>
                </label>
              </div>
            </ng-container>

          </ng-container>

          <!-- DATE -->
          <ng-container *ngIf="f.type === 'date'">
            
            <!-- Default Layout -->
            <ng-container *ngIf="!f.layoutMode || f.layoutMode === 'default'">
              <label [for]="f.key" [ngClass]="f.labelClass || ''">
                {{ getFieldLabel(f) }}
                <span *ngIf="f.required" class="required">*</span>
              </label>
              <input 
                type="date" 
                [id]="f.key"
                class="form-control" 
                [formControlName]="f.key" 
                [ngClass]="f.inputClass || ''"
                [class.is-invalid]="form.get(f.key)?.invalid && form.get(f.key)?.touched" />
              
              <div *ngIf="form.get(f.key)?.invalid && form.get(f.key)?.touched" class="error-message">
                This field is required
              </div>
            </ng-container>

            <!-- Split Layout -->
            <ng-container *ngIf="f.layoutMode === 'split'">
              <div class="field-split-layout d-flex">
                <label [for]="f.key" [class]="(f.labelClass || '') + ' ' + (f.labelWidth || 'col-span-3')">
                  {{ getFieldLabel(f) }}
                  <span *ngIf="f.required" class="required">*</span>
                </label>

                <div [ngClass]="f.inputWidth || 'col-span-9'">
                  <input 
                    type="date" 
                    [id]="f.key"
                    class="form-control" 
                    [formControlName]="f.key" 
                    [ngClass]="f.inputClass || ''"
                    [class.is-invalid]="form.get(f.key)?.invalid && form.get(f.key)?.touched" />
                  
                  <div *ngIf="form.get(f.key)?.invalid && form.get(f.key)?.touched" class="error-message">
                    This field is required
                  </div>
                </div>
              </div>
            </ng-container>

            <!-- Inline Layout -->
            <ng-container *ngIf="f.layoutMode === 'inline'">
              <div class="field-inline-layout">
                <label [for]="f.key" [ngClass]="f.labelClass || ''">
                  {{ getFieldLabel(f) }}
                  <span *ngIf="f.required" class="required">*</span>
                </label>

                <input 
                  type="date" 
                  [id]="f.key"
                  class="form-control form-control-inline" 
                  [formControlName]="f.key" 
                  [ngClass]="f.inputClass || ''"
                  [class.is-invalid]="form.get(f.key)?.invalid && form.get(f.key)?.touched" />
                
                <div *ngIf="form.get(f.key)?.invalid && form.get(f.key)?.touched" class="error-message">
                  This field is required
                </div>
              </div>
            </ng-container>

          </ng-container>

          <!-- TEXTAREA -->
          <ng-container *ngIf="f.type === 'textarea'">
            
            <!-- Default Layout -->
            <ng-container *ngIf="!f.layoutMode || f.layoutMode === 'default'">
              <label [for]="f.key" [ngClass]="f.labelClass || ''">
                {{ getFieldLabel(f) }}
                <span *ngIf="f.required" class="required">*</span>
              </label>
              <textarea 
                [id]="f.key"
                class="form-control" 
                rows="3" 
                [formControlName]="f.key" 
                [ngClass]="f.inputClass || ''"
                [class.is-invalid]="form.get(f.key)?.invalid && form.get(f.key)?.touched">
              </textarea>
              
              <div *ngIf="form.get(f.key)?.invalid && form.get(f.key)?.touched" class="error-message">
                This field is required
              </div>
            </ng-container>

            <!-- Split Layout -->
            <ng-container *ngIf="f.layoutMode === 'split'">
              <div class="field-split-layout">
                <label [for]="f.key" [ngClass]="(f.labelClass || '') + ' ' + (f.labelWidth || 'col-span-3')">
                  {{ getFieldLabel(f) }}
                  <span *ngIf="f.required" class="required">*</span>
                </label>

                <div [ngClass]="f.inputWidth || 'col-span-9'">
                  <textarea 
                    [id]="f.key"
                    class="form-control" 
                    rows="3" 
                    [formControlName]="f.key" 
                    [ngClass]="f.inputClass || ''"
                    [class.is-invalid]="form.get(f.key)?.invalid && form.get(f.key)?.touched">
                  </textarea>
                  
                  <div *ngIf="form.get(f.key)?.invalid && form.get(f.key)?.touched" class="error-message">
                    This field is required
                  </div>
                </div>
              </div>
            </ng-container>

            <!-- Inline Layout -->
            <ng-container *ngIf="f.layoutMode === 'inline'">
              <div class="field-inline-layout field-inline-textarea">
                <label [for]="f.key" [ngClass]="f.labelClass || ''">
                  {{ getFieldLabel(f) }}
                  <span *ngIf="f.required" class="required">*</span>
                </label>

                <textarea 
                  [id]="f.key"
                  class="form-control form-control-inline" 
                  rows="3" 
                  [formControlName]="f.key" 
                  [ngClass]="f.inputClass || ''"
                  [class.is-invalid]="form.get(f.key)?.invalid && form.get(f.key)?.touched">
                </textarea>
                
                <div *ngIf="form.get(f.key)?.invalid && form.get(f.key)?.touched" class="error-message">
                  This field is required
                </div>
              </div>
            </ng-container>

          </ng-container>

          <!-- RADIO -->
          <ng-container *ngIf="f.type === 'radio'">
            
            <!-- Default Layout -->
            <ng-container *ngIf="!f.layoutMode || f.layoutMode === 'default'">
              <label [ngClass]="f.labelClass || ''">
                {{ getFieldLabel(f) }}
                <span *ngIf="f.required" class="required">*</span>
              </label>

              <div 
                class="radio-group" 
                [ngClass]="f.inputLayout === 'horizontal' ? 'radio-group-horizontal' : 'radio-group-vertical'">
                <div *ngIf="fieldLoading[f.key]" class="loading-text">Loading options...</div>
                
                <label 
                  *ngFor="let o of (f.options && f.options.length > 0 ? f.options : fieldOptions[f.key])" 
                  class="radio-label"
                  [for]="f.key + '_' + o.id">
                  <input 
                    type="radio" 
                    [id]="f.key + '_' + o.id"
                    [value]="o.id" 
                    [formControlName]="f.key" 
                    [ngClass]="f.inputClass || ''" />
                  {{ o.name }}
                </label>
              </div>
            </ng-container>

            <!-- Split Layout -->
            <ng-container *ngIf="f.layoutMode === 'split'">
              <div class="field-split-layout">
                <label [ngClass]="(f.labelClass || '') + ' ' + (f.labelWidth || 'col-span-3')">
                  {{ getFieldLabel(f) }}
                  <span *ngIf="f.required" class="required">*</span>
                </label>

                <div [ngClass]="f.inputWidth || 'col-span-9'">
                  <div 
                    class="radio-group" 
                    [ngClass]="f.inputLayout === 'horizontal' ? 'radio-group-horizontal' : 'radio-group-vertical'">
                    <div *ngIf="fieldLoading[f.key]" class="loading-text">Loading options...</div>
                    
                    <label 
                      *ngFor="let o of (f.options && f.options.length > 0 ? f.options : fieldOptions[f.key])" 
                      class="radio-label"
                      [for]="f.key + '_' + o.id">
                      <input 
                        type="radio" 
                        [id]="f.key + '_' + o.id"
                        [value]="o.id" 
                        [formControlName]="f.key" 
                        [ngClass]="f.inputClass || ''" />
                      {{ o.name }}
                    </label>
                  </div>
                </div>
              </div>
            </ng-container>

            <!-- Inline Layout -->
            <ng-container *ngIf="f.layoutMode === 'inline'">
              <div class="field-inline-layout">
                <label [ngClass]="f.labelClass || ''">
                  {{ getFieldLabel(f) }}
                  <span *ngIf="f.required" class="required">*</span>
                </label>

                <div 
                  class="radio-group-inline-compact" 
                  [ngClass]="f.inputLayout === 'horizontal' ? 'radio-group-horizontal' : 'radio-group-vertical'">
                  <div *ngIf="fieldLoading[f.key]" class="loading-text">Loading options...</div>
                  
                  <label 
                    *ngFor="let o of (f.options && f.options.length > 0 ? f.options : fieldOptions[f.key])" 
                    class="radio-label"
                    [for]="f.key + '_' + o.id">
                    <input 
                      type="radio" 
                      [id]="f.key + '_' + o.id"
                      [value]="o.id" 
                      [formControlName]="f.key" 
                      [ngClass]="f.inputClass || ''" />
                    {{ o.name }}
                  </label>
                </div>
              </div>
            </ng-container>

            <div *ngIf="form.get(f.key)?.invalid && form.get(f.key)?.touched" class="error-message">
              Please select an option
            </div>
          </ng-container>

        </div>

      </div>

      <!-- Action buttons -->
      <div class="form-actions">
        <button 
          *ngFor="let a of config.actions" 
          type="button"
          class="btn"
          [ngClass]="a.type === 'primary' ? 'btn-submit' : 'btn-cancel'" 
          (click)="handleAction(a)"
          [disabled]="a.key === 'submit' && form.invalid">
          {{ a.label }}
        </button>
      </div>

    </form>
  </div>
</div>

<!-- Loading state -->
<div *ngIf="!config || !form" class="loading-container">
  <p>Loading form...</p>
</div>